<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat dengan SMARDOS - Smart Asisten Dosen</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap"
      rel="stylesheet"
    />
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸŽ“</text></svg>"
    />
    <style>
      body {
        font-family: "Nunito", sans-serif;
      }

      /* Scrollbar Kustom - Tema Biru */
      #chat-box::-webkit-scrollbar {
        width: 8px;
      }

      #chat-box::-webkit-scrollbar-track {
        background: #f1f5f9;
      }

      #chat-box::-webkit-scrollbar-thumb {
        background-color: #3b82f6;
        border-radius: 20px;
        border: 2px solid #f1f5f9;
      }

      .glass-chat {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(15px);
        border: 1px solid rgba(59, 130, 246, 0.2);
      }
    </style>
  </head>
  <body class="bg-slate-100 bg-cover bg-fixed bg-center text-slate-800">
    <div class="flex flex-col h-screen p-2 md:p-4">
      <div
        class="flex-1 flex flex-col max-w-4xl w-full mx-auto glass-chat rounded-2xl shadow-xl border border-blue-100"
      >
        <header
          class="flex items-center p-4 border-b border-blue-100 flex-shrink-0 bg-white rounded-t-2xl"
        >
          <a
            href="{{ url_for('main.index') }}"
            class="text-blue-600 hover:bg-blue-50 rounded-full p-2 mr-3 transition-colors"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 19l-7-7 7-7"
              />
            </svg>
          </a>
          <div
            class="w-12 h-12 rounded-full border-2 border-blue-500 bg-blue-100 flex items-center justify-center text-2xl"
          >
            ðŸŽ“
          </div>
          <div class="ml-4">
            <h2 class="text-xl font-bold text-blue-900">SMARDOS</h2>
            <p class="text-xs font-semibold text-green-500 flex items-center">
              <span
                class="w-2 h-2 bg-green-500 rounded-full mr-2 animate-pulse"
              ></span>
              Sistem Aktif
            </p>
          </div>
        </header>

        <div
          id="chat-box"
          class="flex-1 p-4 md:p-6 overflow-y-auto bg-slate-50/50"
        ></div>

        <footer class="p-4 bg-white rounded-b-2xl border-t border-blue-50">
          <form id="chat-form" class="flex items-center space-x-3">
            <input
              type="text"
              id="user-input"
              placeholder="Tanyakan topik akademik atau tugas Anda di sini..."
              autocomplete="off"
              class="flex-1 p-3.5 bg-slate-100 text-slate-900 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white transition-all"
            />

            <button
              type="submit"
              class="bg-blue-600 hover:bg-blue-700 text-white rounded-xl p-3.5 shadow-md shadow-blue-200 transform hover:scale-105 transition-all"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-6 w-6"
                viewBox="0 0 20 20"
                fill="currentColor"
              >
                <path
                  d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"
                />
              </svg>
            </button>
          </form>
          <p class="text-[10px] text-center text-slate-400 mt-2">
            SMARDOS dapat membuat kesalahan. Pertimbangkan untuk memeriksa
            informasi penting.
          </p>
        </footer>
      </div>
    </div>

    <script>
      const chatBox = document.getElementById("chat-box");
      const chatForm = document.getElementById("chat-form");
      const userInput = document.getElementById("user-input");

      function displayMessage(message, sender) {
        const messageWrapper = document.createElement("div");
        messageWrapper.classList.add(
          "flex",
          "items-end",
          "mb-6",
          "animate-fade-in"
        );

        let messageContent;
        if (sender === "user") {
          messageWrapper.classList.add("justify-end");
          messageContent = `
                        <div class="px-4 py-3 bg-blue-600 text-white rounded-2xl rounded-tr-none max-w-[85%] md:max-w-md shadow-sm break-words text-sm md:text-base">
                            ${message}
                        </div>
                        <div class="w-8 h-8 rounded-full bg-slate-300 ml-3 flex-shrink-0 flex items-center justify-center text-xs font-bold text-white">U</div>
                    `;
        } else {
          messageWrapper.classList.add("justify-start");
          messageContent = `
                        <div class="w-8 h-8 rounded-full bg-blue-500 mr-3 flex-shrink-0 flex items-center justify-center text-xs">ðŸŽ“</div>
                        <div class="px-4 py-3 bg-white text-slate-800 border border-blue-100 rounded-2xl rounded-tl-none max-w-[85%] md:max-w-md shadow-sm break-words text-sm md:text-base">
                            ${message}
                        </div>
                    `;
        }
        messageWrapper.innerHTML = messageContent;
        chatBox.appendChild(messageWrapper);
        chatBox.scrollTop = chatBox.scrollHeight;
      }

      function displayTypingIndicator() {
        const typingIndicator = document.createElement("div");
        typingIndicator.id = "typing-indicator";
        typingIndicator.classList.add("flex", "items-end", "mb-6");
        typingIndicator.innerHTML = `
                    <div class="w-8 h-8 rounded-full bg-blue-500 mr-3 flex items-center justify-center text-xs">ðŸŽ“</div>
                    <div class="px-4 py-3 bg-white border border-blue-100 rounded-2xl rounded-tl-none">
                        <div class="flex items-center space-x-1">
                            <span class="w-1.5 h-1.5 bg-blue-400 rounded-full animate-bounce" style="animation-delay: 0s;"></span>
                            <span class="w-1.5 h-1.5 bg-blue-400 rounded-full animate-bounce" style="animation-delay: 0.2s;"></span>
                            <span class="w-1.5 h-1.5 bg-blue-400 rounded-full animate-bounce" style="animation-delay: 0.4s;"></span>
                        </div>
                    </div>
                `;
        chatBox.appendChild(typingIndicator);
        chatBox.scrollTop = chatBox.scrollHeight;
      }

      function removeTypingIndicator() {
        const indicator = document.getElementById("typing-indicator");
        if (indicator) indicator.remove();
      }

      chatForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const userMessage = userInput.value.trim();
        if (!userMessage) return;

        displayMessage(userMessage, "user");
        userInput.value = "";
        displayTypingIndicator();

        try {
          const response = await fetch("/ask", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ question: userMessage }),
          });

          if (!response.ok) throw new Error(`Status: ${response.status}`);

          const data = await response.json();
          removeTypingIndicator();

          if (data.answer) {
            displayMessage(data.answer, "bot");
          } else {
            throw new Error("Format tidak valid.");
          }
        } catch (error) {
          removeTypingIndicator();
          displayMessage(
            "Mohon maaf, terjadi gangguan teknis pada server SMARDOS. Silakan coba beberapa saat lagi.",
            "bot"
          );
        }
      });

      window.onload = () => {
        displayMessage(
          "Halo! Saya SMARDOS ðŸ¤–, asisten akademik digital Anda. Ada materi kuliah atau tugas yang ingin didiskusikan hari ini?",
          "bot"
        );
        userInput.focus();
      };

      const style = document.createElement("style");
      style.innerHTML = `
                @keyframes fade-in {
                    from { opacity: 0; transform: translateY(10px); }
                    to { opacity: 1; transform: translateY(0); }
                }
                .animate-fade-in {
                    animation: fade-in 0.4s ease-out forwards;
                }
            `;
      document.head.appendChild(style);
    </script>
  </body>
</html>
